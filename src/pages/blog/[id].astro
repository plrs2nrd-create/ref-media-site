---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

import { readItems, readItem } from "@directus/sdk";
import { directus } from "../../lib/directus";

export const prerender = true;

type Post = {
  id: string;
  title?: string;
  content?: string;
  date_created?: string;
};

export async function getStaticPaths() {
  try {
    const items = (await directus.request(
      readItems("posts", {
        fields: ["id"],
        limit: -1,
      })
    )) as Array<Pick<Post, "id">>;

    return items
      .filter((p) => p?.id)
      .map((p) => ({ params: { id: String(p.id) } }));
  } catch (e) {
    console.error("Directus getStaticPaths error:", e);
    return [];
  }
}

const { id } = Astro.params;

let post: Post | null = null;

try {
  post = (await directus.request(
    readItem("posts", String(id), {
      fields: ["id", "title", "content", "date_created"],
    })
  )) as Post;
} catch (e: any) {
  // если контент запрещён — попробуем хотя бы заголовок
  try {
    post = (await directus.request(
      readItem("posts", String(id), {
        fields: ["id", "title", "date_created"],
      })
    )) as Post;
  } catch (e2) {
    console.error("Directus post fetch error:", e2);
    post = null;
  }
}

const pageTitle = post?.title ? `Refined Lab | ${post.title}` : "Refined Lab | Пост";
const html = post?.content ?? "";
---

<Layout title={pageTitle}>
  <Header />

  <main id="main-content" style="max-width: 800px; margin: 0 auto; padding: 2rem;">
    {post ? (
      <>
        <nav style="margin-bottom: 1.5rem;">
          <a href="/blog" style="text-decoration: underline; opacity: 0.85;">← Назад к статьям</a>
        </nav>

        <article>
          <h1 style="font-size: 2.25rem; font-weight: 700; margin-bottom: 1rem;">
            {post.title ?? "Без названия"}
          </h1>

          {html ? (
            <div style="line-height: 1.8;" set:html={html} />
          ) : (
            <p style="opacity: 0.8;">Контент недоступен или пуст.</p>
          )}
        </article>
      </>
    ) : (
      <>
        <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.75rem;">Пост не найден</h1>
        <a href="/blog" style="text-decoration: underline;">Перейти к списку статей</a>
      </>
    )}
  </main>

  <Footer />
</Layout>
