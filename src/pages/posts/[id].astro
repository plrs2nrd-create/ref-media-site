---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

import { readItems, readItem } from "@directus/sdk";
import { directus } from "../../lib/directus";

export const prerender = true;

type Post = {
  id: string | number;
  title?: string;
  description?: string;
  content?: string;
  body?: string;
  date_created?: string;
  date_updated?: string;
};

export async function getStaticPaths() {
  try {
    const posts = (await directus.request(
      readItems("posts", {
        fields: ["id"],
        limit: -1,
        // filter: { status: { _eq: "published" } },
      })
    )) as Array<Pick<Post, "id">>;

    return posts
      .filter((p) => p?.id !== undefined && p?.id !== null)
      .map((p) => ({
        params: { id: String(p.id) },
      }));
  } catch (error) {
    console.error("Directus getStaticPaths error:", error);
    return [];
  }
}

const { id } = Astro.params;

let post: Post | null = null;

try {
  post = (await directus.request(
    readItem("posts", id, {
      fields: [
        "id",
        "title",
        "description",
        "content",
        "body",
        "date_created",
        "date_updated",
      ],
    })
  )) as Post;
} catch (error) {
  console.error("Directus post fetch error:", error);
  post = null;
}

const pageTitle = post?.title ? `Refined Lab | ${post.title}` : "Refined Lab | Пост";
const html = post?.content ?? post?.body ?? "";
---

<Layout title={pageTitle}>
  <Header />

  <main id="main-content" style="max-width: 800px; margin: 0 auto; padding: 2rem;">
    {post ? (
      <>
        <nav style="margin-bottom: 1.5rem;">
          <a href="/" style="text-decoration: underline; opacity: 0.85;">← На главную</a>
          <span style="opacity: 0.6;"> &nbsp;•&nbsp; </span>
          <a href="/posts" style="text-decoration: underline; opacity: 0.85;">Все статьи</a>
        </nav>

        <article>
          <h1 style="font-size: 2.25rem; font-weight: 700; margin-bottom: 0.75rem;">
            {post.title ?? "Без названия"}
          </h1>

          {post.description ? (
            <p style="font-size: 1.1rem; opacity: 0.85; margin-bottom: 1.5rem;">
              {post.description}
            </p>
          ) : null}

          {html ? (
            <div style="line-height: 1.8;" set:html={html} />
          ) : (
            <p style="opacity: 0.8;">Контент пока пуст.</p>
          )}
        </article>
      </>
    ) : (
      <>
        <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.75rem;">Пост не найден</h1>
        <p style="opacity: 0.85; margin-bottom: 1.5rem;">
          Возможно, запись удалена или недоступна.
        </p>
        <a href="/" style="text-decoration: underline;">На главную</a>
      </>
    )}
  </main>

  <Footer />
</Layout>
