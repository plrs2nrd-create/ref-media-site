---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

import { readItems } from "@directus/sdk";
import { directus } from "../lib/directus";

export const prerender = true;

type Post = {
  id: string | number;
  title?: string;
  description?: string;
  date_created?: string;
};

let directusPosts: Post[] = [];

try {
  directusPosts = (await directus.request(
    readItems("posts", {
      fields: ["id", "title", "description", "date_created"],
      sort: ["-date_created"],
      limit: 10,
      // filter: { status: { _eq: "published" } },
    })
  )) as Post[];
} catch (error) {
  console.error("Directus Connection Error (index):", error);
  directusPosts = [];
}
---

<Layout title="Refined Lab">
  <Header />

  <main id="main-content" style="max-width: 900px; margin: 0 auto; padding: 2rem;">
    <section style="margin-bottom: 2rem;">
      <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">Refined Lab</h1>
      <p style="opacity: 0.85;">Последние статьи из Directus</p>
    </section>

    <section>
      {directusPosts.length > 0 ? (
        <ul style="list-style: none; padding: 0; margin: 0;">
          {directusPosts.map((post) => (
            <li style="padding: 1.25rem 0; border-bottom: 1px solid rgba(0,0,0,.08);">
              <a href={`/posts/${post.id}`} style="text-decoration: none;">
                <h3 style="font-size: 1.25rem; margin: 0 0 0.35rem 0; text-decoration: underline;">
                  {post.title ?? "Без названия"}
                </h3>
              </a>
              {post.description ? <p style="margin: 0; opacity: 0.85;">{post.description}</p> : null}
            </li>
          ))}
        </ul>
      ) : (
        <p style="opacity: 0.8;">Статей пока нет (или Directus недоступен на этапе сборки).</p>
      )}
    </section>
  </main>

  <Footer />
</Layout>
