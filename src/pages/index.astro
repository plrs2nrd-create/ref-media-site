---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

import { readItems, readItem } from "@directus/sdk";
import { directus } from "../../lib/directus";

export const prerender = true;

type Post = {
  id: string | number;
  title?: string;
  description?: string;
  content?: string;
  body?: string;
  date_created?: string;
  date_updated?: string;
};

/**
 * Variant A (SSG): Astro требует getStaticPaths() для динамических роутов при prerender=true.
 * Генерим страницы /posts/:id на этапе build.
 */
export async function getStaticPaths() {
  try {
    const posts = (await directus.request(
      readItems("posts", {
        fields: ["id"],
        limit: -1,
        // Если есть поле публикации — включи фильтр:
        // filter: { status: { _eq: "published" } },
      })
    )) as Array<Pick<Post, "id">>;

    return posts
      .filter((p) => p?.id !== undefined && p?.id !== null)
      .map((p) => ({
        params: { id: String(p.id) },
      }));
  } catch (error) {
    console.error("Directus getStaticPaths error:", error);
    return [];
  }
}

const { id } = Astro.params;

// Если PK числовой — можно аккуратно кастануть (не обязательно, но помогает)
const pk: string | number =
  typeof id === "string" && /^\d+$/.test(id) ? Number(id) : (id as string);

let post: Post | null = null;

try {
  post = (await directus.request(
    readItem("posts", pk, {
      fields: [
        "id",
        "title",
        "description",
        "content",
        "body",
        "date_created",
        "date_updated",
      ],
    })
  )) as Post;
} catch (error) {
  console.error("Directus post fetch error:", error);
  post = null;
}

const pageTitle = post?.title ? `Refined Lab | ${post.title}` : "Refined Lab | Пост";
const html = post?.content ?? post?.body ?? "";
---

<Layout title={pageTitle}>
  <Header />

  <main id="main-content" style="max-width: 800px; margin: 0 auto; padding: 2rem;">
    {post ? (
      <>
        <nav style="margin-bottom: 1.5rem;">
          <a href="/posts" style="text-decoration: underline; opacity: 0.85;">
            ← Назад к статьям
          </a>
        </nav>

        <article>
          <h1 style="font-size: 2.25rem; font-weight: 700; margin-bottom: 0.75rem;">
            {post.title}
          </h1>

          {post.description ? (
            <p style="font-size: 1.1rem; opacity: 0.85; margin-bottom: 1.5rem;">
              {post.description}
            </p>
          ) : null}

          {html ? (
            <div style="line-height: 1.8;" set:html={html} />
          ) : (
            <p style="opacity: 0.8;">Контент пока пуст.</p>
          )}
        </article>
      </>
    ) : (
      <>
        <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.75rem;">
          Пост не найден
        </h1>
        <p style="opacity: 0.85; margin-bottom: 1.5rem;">
          Возможно, запись удалена или недоступна.
        </p>
        <a href="/posts" style="text-decoration: underline;">Перейти к списку статей</a>
      </>
    )}
  </main>

  <Footer />
</Layout>
